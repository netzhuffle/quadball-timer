name: Deploy production

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: timer-production-deploy
  cancel-in-progress: false

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check
        run: bun run check

      - name: Test
        run: bun run test

      - name: Build
        run: bun run build.ts

      - name: Prepare release bundle
        run: |
          set -euo pipefail
          mkdir -p release
          rsync -a \
            --exclude '.git/' \
            --exclude 'node_modules/' \
            --exclude 'dist/' \
            --exclude '.github/' \
            ./ release/

      - name: Upload release artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-${{ github.sha }}
          path: release
          if-no-files-found: error
          retention-days: 7

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: ci
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://timer.quadball.app
    steps:
      - name: Download release artifact
        uses: actions/download-artifact@v7
        with:
          name: release-${{ github.sha }}
          path: release

      - name: Configure SSH
        env:
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_KNOWN_HOSTS: ${{ secrets.PROD_KNOWN_HOSTS }}
        run: |
          set -euo pipefail
          : "${PROD_SSH_KEY:?Missing PROD_SSH_KEY secret}"
          : "${PROD_KNOWN_HOSTS:?Missing PROD_KNOWN_HOSTS secret}"

          install -m 700 -d ~/.ssh
          printf '%s\n' "$PROD_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "$PROD_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Sync release to server
        env:
          DEPLOY_HOST: ${{ secrets.PROD_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_USER }}
          DEPLOY_BASE: ${{ vars.PROD_DEPLOY_BASE }}
        run: |
          set -euo pipefail
          : "${DEPLOY_HOST:?Missing PROD_HOST secret}"
          : "${DEPLOY_USER:?Missing PROD_USER secret}"

          base_dir="${DEPLOY_BASE:-/srv/quadball-timer}"
          release_id="${GITHUB_SHA}"
          remote_release_dir="${base_dir}/releases/${release_id}"
          ssh_opts="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes"

          ssh $ssh_opts "${DEPLOY_USER}@${DEPLOY_HOST}" "mkdir -p '${remote_release_dir}'"

          rsync -az --delete \
            -e "ssh $ssh_opts" \
            release/ \
            "${DEPLOY_USER}@${DEPLOY_HOST}:${remote_release_dir}/"

      - name: Activate release
        env:
          DEPLOY_HOST: ${{ secrets.PROD_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_USER }}
          DEPLOY_BASE: ${{ vars.PROD_DEPLOY_BASE }}
          PROD_SERVICE_NAME: ${{ vars.PROD_SERVICE_NAME }}
          PROD_APP_PORT: ${{ vars.PROD_APP_PORT }}
        run: |
          set -euo pipefail
          : "${DEPLOY_HOST:?Missing PROD_HOST secret}"
          : "${DEPLOY_USER:?Missing PROD_USER secret}"

          base_dir="${DEPLOY_BASE:-/srv/quadball-timer}"
          service_name="${PROD_SERVICE_NAME:-quadball-timer}"
          app_port="${PROD_APP_PORT:-3000}"
          release_id="${GITHUB_SHA}"
          remote_release_dir="${base_dir}/releases/${release_id}"
          ssh_opts="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes"

          ssh $ssh_opts "${DEPLOY_USER}@${DEPLOY_HOST}" "\
            chmod +x '${remote_release_dir}/deploy/activate-release.sh' && \
            '${remote_release_dir}/deploy/activate-release.sh' \
              --base-dir '${base_dir}' \
              --release '${release_id}' \
              --service '${service_name}' \
              --port '${app_port}'"
